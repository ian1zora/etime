t===O||w(t.right)?(n[i++]=t,C(t,!0)):t=t.right:t=t.left;return C(e.root,!1),n}(this)},e.prototype.insert=function(e){j(this,e),this._normalizeDeltaIfNecessary()},e.prototype.delete=function(e){z(this,e),this._normalizeDeltaIfNecessary()},e.prototype.resolveNode=function(e,t){for(var n=e,i=0;e!==this.root;)e===e.parent.right&&(i+=e.parent.delta),e=e.parent;var o=n.start+i,r=n.end+i;n.setCachedOffsets(o,r,t)},e.prototype.acceptReplace=function(e,t,n,i){for(var o=function(e,t,n){var i=e.root,o=0,r=0,s=0,a=[],u=0;for(;i!==O;)if(w(i))C(i.left,!1),C(i.right,!1),i===i.parent.right&&(o-=i.parent.delta),i=i.parent;else{if(!w(i.left)){if(o+i.maxEnd<t){C(i,!0);continue}if(i.left!==O){i=i.left;continue}}(r=o+i.start)>n?C(i,!0):((s=o+i.end)>=t&&(i.setCachedOffsets(r,s,0),a[u++]=i),C(i,!0),i.right===O||w(i.right)||(o+=i.delta,i=i.right))}return C(e.root,!1),a}(this,e,e+t),r=0,s=o.length;r<s;r++){z(this,a=o[r])}this._normalizeDeltaIfNecessary(),function(e,t,n,i){var o=e.root,r=0,s=i-(n-t);for(;o!==O;)if(w(o))C(o.left,!1),C(o.right,!1),o===o.parent.right&&(r-=o.parent.delta),U(o),o=o.parent;else{if(!w(o.left)){if(r+o.maxEnd<t){C(o,!0);continue}if(o.left!==O){o=o.left;continue}}r+o.start>n?(o.start+=s,o.end+=s,o.delta+=s,(o.delta<-1073741824||o.delta>1073741824)&&(e.requestNormalizeDelta=!0),C(o,!0)):(C(o,!0),o.right===O||w(o.right)||(r+=o.delta,o=o.right))}C(e.root,!1)}(this,e,e+t,n),this._normalizeDeltaIfNecessary();for(r=0,s=o.length;r<s;r++){var a;(a=o[r]).start=a.cachedAbsoluteStart,a.end=a.cachedAbsoluteEnd,k(a,e,e+t,n,i),a.maxEnd=a.end,j(this,a)}this._normalizeDeltaIfNecessary()},e.prototype._normalizeDeltaIfNecessary=function(){this.requestNormalizeDelta&&(this.requestNormalizeDelta=!1,function(e){var t=e.root,n=0;for(;t!==O;)t.left===O||w(t.left)?t.right===O||w(t.right)?(t.start=n+t.start,t.end=n+t.end,t.delta=0,U(t),C(t,!0),C(t.left,!1),C(t.right,!1),t===t.parent.right&&(n-=t.parent.delta),t=t.parent):(n+=t.delta,t=t.right):t=t.left;C(e.root,!1)}(this))},e}();function E(e,t,n,i){return e<n||!(e>n)&&(1!==i&&(2===i||t))}function k(e,t,n,i,o){var r=function(e){return(48&e.metadata)>>>4}(e),s=0===r||2===r,a=1===r||2===r,u=n-t,l=i,c=Math.min(u,l),d=e.start,h=!1,p=e.end,g=!1;t<=d&&p<=n&&function(e){return(64&e.metadata)>>>6==1}(e)&&(e.start=t,h=!0,e.end=t,g=!0);var f=o?1:u>0?2:0;if(!h&&E(d,s,t,f)&&(h=!0),!g&&E(p,a,t,f)&&(g=!0),c>0&&!o){f=u>l?2:0;!h&&E(d,s,t+c,f)&&(h=!0),!g&&E(p,a,t+c,f)&&(g=!0)}f=o?1:0;!h&&E(d,s,n,f)&&(e.start=t+l,h=!0),!g&&E(p,a,n,f)&&(e.end=t+l,g=!0);var m=l-u;h||(e.start=Math.max(0,d+m)),g||(e.end=Math.max(0,p+m)),e.start>e.end&&(e.end=e.start)}function j(e,t){if(e.root===O)return t.parent=O,t.left=O,t.right=O,M(t,0),e.root=t,e.root;!function(e,t){var n=0,i=e.root,o=t.start,r=t.end;for(;;){if(H(o,r,i.start+n,i.end+n)<0){if(i.left===O){t.start-=n,t.end-=n,t.maxEnd-=n,i.left=t;break}i=i.left}else{if(i.right===O){t.start-=n+i.delta,t.end-=n+i.delta,t.maxEnd-=n+i.delta,i.right=t;break}n+=i.delta,i=i.right}}t.parent=i,t.left=O,t.right=O,M(t,1)}(e,t),V(t.parent);for(var n=t;n!==e.root&&1===_(n.parent);){var i;if(n.parent===n.parent.parent.left)1===_(i=n.parent.parent.right)?(M(n.parent,0),M(i,0),M(n.parent.parent,1),n=n.parent.parent):(n===n.parent.right&&R(e,n=n.parent),M(n.parent,0),M(n.parent.parent,1),W(e,n.parent.parent));else 1===_(i=n.parent.parent.left)?(M(n.parent,0),M(i,0),M(n.parent.parent,1),n=n.parent.parent):(n===n.parent.left&&W(e,n=n.parent),M(n.parent,0),M(n.parent.parent,1),R(e,n.parent.parent))}return M(e.root,0),t}function z(e,t){var n,i;if(t.left===O?(i=t,(n=t.right).delta+=t.delta,(n.delta<-1073741824||n.delta>1073741824)&&(e.requestNormalizeDelta=!0),n.start+=t.delta,n.end+=t.delta):t.right===O?(n=t.left,i=t):((n=(i=function(e){for(;e.left!==O;)e=e.left;return e}(t.right)).right).start+=i.delta,n.end+=i.delta,n.delta+=i.delta,(n.delta<-1073741824||n.delta>1073741824)&&(e.requestNormalizeDelta=!0),i.start+=t.delta,i.end+=t.delta,i.delta=t.delta,(