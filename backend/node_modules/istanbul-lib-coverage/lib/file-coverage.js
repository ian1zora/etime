/*
 Copyright 2012-2015, Yahoo Inc.
 Copyrights licensed under the New BSD License. See the accompanying LICENSE file for terms.
 */
'use strict';

const percent = require('./percent');
const dataProperties = require('./data-properties');
const { CoverageSummary } = require('./coverage-summary');

// returns a data object that represents empty coverage
function emptyCoverage(filePath, reportLogic) {
    const cov = {
        path: filePath,
        statementMap: {},
        fnMap: {},
        branchMap: {},
        s: {},
        f: {},
        b: {}
    };
    if (reportLogic) cov.bT = {};
    return cov;
}

// asserts that a data object "looks like" a coverage object
function assertValidObject(obj) {
    const valid =
        obj &&
        obj.path &&
        obj.statementMap &&
        obj.fnMap &&
        obj.branchMap &&
        obj.s &&
        obj.f &&
        obj.b;
    if (!valid) {
        throw new Error(
            'Invalid file coverage object, missing keys, found:' +
                Object.keys(obj).join(',')
        );
    }
}

const keyFromLoc = ({ start, end }) =>
    `${start.line}|${start.column}|${end.line}|${end.column}`;

const isObj = o => !!o && typeof o === 'object';
const isLineCol = o =>
    isObj(o) && typeof o.line === 'number' && typeof o.column === 'number';
const isLoc = o => isObj(o) && isLineCol(o.start) && isLineCol(o.end);
const getLoc = o => (isLoc(o) ? o : isLoc(o.loc) ? o.loc : null);

// When merging, we can have a case where two ranges cover
// the same block of code with `hits=1`, and each carve out a
// different range with `hits=0` to indicate it's uncovered.
// Find the nearest container so that we can properly indicate
// that both sections are hit.
// Returns null if no containing item is found.
const findNearestContainer = (item, map) => {
    const itemLoc = getLoc(item);
    if (!itemLoc) return null;
    // the B item is not an identified range in the A set, BUT
    // it may be contained by an identified A range. If so, then
    // any hit of that containing A range counts as a hit of this
    // B range as well. We have to find the *narrowest* containing
    // range to be accurate, since ranges can be hit and un-hit
    // in a nested fashion.
    let nearestContainingItem = null;
    let containerDistance = null;
    let containerKey = null;
    for (const [i, mapItem] of Object.entries(map)) {
        const mapLoc = getLoc(mapItem);
        if (!mapLoc) continue;
        // contained if all of line distances are > 0
        // or line distance is 0 and col dist is >= 0
        const distance = [
            itemLoc.start.line - mapLoc.start.line,
            itemLoc.start.column - mapLoc.start.column,
            mapLoc.end.line - itemLoc.end.line,
            mapLoc.end.column - itemLoc.end.column
        ];
        if (
            distance[0] < 0 ||
            distance[2] < 0 ||
            (distance[0] === 0 && distance[1] < 0) ||
            (distance[2] === 0 && distance[3] < 0)
        ) {
            continue;
        }
        if (nearestContainingItem === null) {
            containerDistance = distance;
            nearestContainingItem = mapItem;
            containerKey = i;
            continue;
        }
        // closer line more relevant than closer column
        const closerBefore =
            distance[0] < containerDistance[0] ||
            (distance[0] === 0 && distance[1] < containerDistance[1]);
        const closerAfter =
            distance[2] < containerDistance[2] ||
            (distance[2] === 0 && distance[3] < containerDistance[3]);
        if (closerBefore || closerAfter) {
            // closer
            containerDistance = distance;
            nearestContainingItem = mapItem;
            containerKey = i;
        }
    }
    return containerKey;
};

// either add two numbers, or all matching entries in a number[]
const addHits = (aHits, bHits) => {
    if (typeof aHits === 'number' && typeof bHits === 'number') {
        return aHits + bHits;
    } else if (Array.isArray(aHits) && Array.isArray(bHits)) {
        return aHi7048)">\r
<path d="M0.575134 87.7191H99.4249V89.9499C99.4249 91.0545 98.5294 91.9499 97.4249 91.9499H2.57513C1.47057 91.9499 0.575134 91.0545 0.575134 89.9499V87.7191Z" fill="#929292"/>\r
<path fill-rule="evenodd" clip-rule="evenodd" d="M30.2501 34.45H9.94708C8.84251 34.45 7.94708 35.3455 7.94708 36.45V87.7191H92.0529V36.45C92.0529 35.3455 91.1575 34.45 90.0529 34.45H69.7501V38.049H89.5137V83.6002H10.4861V38.049H30.2501V34.45Z" fill="#AAAAAA"/>\r
<rect x="50.8619" y="26.5451" width="16.7359" height="16.7359" fill="#FFB902"/>\r
<rect x="32.4022" y="8.05008" width="16.74" height="16.74" fill="#F25022"/>\r
<rect x="32.4022" y="26.6206" width="16.74" height="16.74" fill="#02A4EF"/>\r
<rect x="50.8481" y="8.05008" width="16.74" height="16.74" fill="#80BA01"/>\r
<rect x="50.8481" y="26.541" width="16.74" height="16.74" fill="#FFB902"/>\r
<path fill-rule="evenodd" clip-rule="evenodd" d="M53.9267 50.9922H46.0733V61.112L38.4572 61.112L50 73.0963L61.5427 61.112L53.9267 61.112V50.9922Z" fill="#C5C5C5"/>\r
<rect x="41.0491" y="75.3253" width="17.9017" height="2.03714" fill="#C5C5C5"/>\r
</g>\r
</svg>\r
`,Xh=`<svg width="420" height="360" viewBox="0 0 420 360" fill="none" xmlns="http://www.w3.org/2000/svg">\r
<g clip-path="url(#clip0_5346_116415)">\r
<path d="M306.92 293.81C307.08 293.09 306.63 292.38 305.91 292.22L294.24 289.61C293.52 289.45 292.81 289.9 292.65 290.62C292.49 291.34 292.94 292.05 293.66 292.21L304.03 294.53L301.71 304.9C301.55 305.62 302 306.33 302.72 306.49C303.44 306.65 304.15 306.2 304.31 305.48L306.92 293.81ZM89.12 244.79C89.53 244.18 89.36 243.35 88.75 242.95C88.14 242.55 87.31 242.71 86.91 243.32L89.12 244.79ZM85.46 245.76C85.12 246.41 85.36 247.21 86.01 247.56C86.66 247.9 87.46 247.66 87.81 247.01L85.46 245.77V245.76ZM85.15 254.35C85.31 253.63 84.86 252.92 84.14 252.77C83.42 252.61 82.71 253.06 82.56 253.78L85.15 254.35ZM81.77 259.33C81.72 260.06 82.27 260.7 83 260.75C83.73 260.8 84.37 260.25 84.42 259.52L81.77 259.34V259.33ZM84.65 267.44C84.56 266.71 83.9 266.19 83.17 266.28C82.44 266.37 81.92 267.03 82.01 267.76L84.65 267.45V267.44ZM82.96 273.23C83.12 273.94 83.83 274.39 84.55 274.23C85.27 274.07 85.71 273.36 85.55 272.64L82.96 273.23ZM87.86 280.3C87.6 279.61 86.83 279.27 86.15 279.53C85.47 279.79 85.12 280.56 85.38 281.24L87.87 280.3H87.86ZM87.54 286.32C87.86 286.98 88.65 287.26 89.31 286.95C89.97 286.63 90.25 285.84 89.94 285.18L87.54 286.32ZM93.83 292.2C93.44 291.58 92.62 291.4 92 291.79C91.38 292.18 91.2 293 91.59 293.62L93.83 292.2ZM94.73 298.16C95.17 298.75 96 298.87 96.59 298.42C97.18 297.98 97.3 297.15 96.85 296.56L94.73 298.16ZM102.05 302.68C101.54 302.15 100.7 302.13 100.17 302.64C99.64 303.15 99.62 303.99 100.13 304.52L102.05 302.68ZM104.12 308.35C104.67 308.84 105.51 308.78 106 308.24C106.49 307.69 106.43 306.85 105.89 306.36L104.13 308.35H104.12ZM112.21 311.27C111.6 310.86 110.78 311.02 110.37 311.63C109.96 312.24 110.12 313.06 110.73 313.48L112.22 311.28L112.21 311.27ZM115.56 316.45C116.2 316.81 117.01 316.59 117.37 315.96C117.74 315.32 117.52 314.51 116.88 314.15L115.56 316.46V316.45ZM124.5 318.09C123.84 317.78 123.04 318.07 122.73 318.73C122.42 319.4 122.71 320.19 123.37 320.5L124.49 318.09H124.5ZM128.71 322.82C129.39 323.1 130.17 322.77 130.44 322.09C130.72 321.41 130.39 320.64 129.71 320.36L128.71 322.82ZM137.78 323.28C137.08 323.06 136.33 323.44 136.11 324.14C135.89 324.84 136.27 325.59 136.97 325.81L137.78 323.28ZM142.54 327.45C143.25 327.64 143.98 327.22 144.17 326.51C144.36 325.8 143.94 325.07 143.23 324.88L142.54 327.45ZM151.61 326.85C150.89 326.71 150.19 327.17 150.05 327.89C149.91 328.61 150.37 329.31 151.09 329.45L151.61 326.85ZM156.8 330.47C157.52 330.58 158.2 330.09 158.32 329.36C158.43 328.63 157.94 327.96 157.21 327.84L156.8 330.46V330.47ZM165.76 328.94C165.03 328.87 164.38 329.4 164.31 330.13C164.24 330.86 164.77 331.51 165.5 331.58L165.76 328.94ZM171.28 332.05C172.01 332.1 172.64 331.54 172.69 330.81C172.74 330.08 172.18 329.45 171.45 329.4L171.28 332.05ZM180.06 329.71C179.33 329.71 178.72 330.29 178.72 331.02C178.72 331.75 179.3 332.36 180.03 332.36L180.06 329.7V329.71ZM185.82 332.34C186.55 332.33 187.14 331.72 187.12 330.99C187.11 330.26 186.5 329.67 185.76 329.69L185.81 332.35L185.82 332.34ZM194.39 329.31C193.66 329.36 193.1 329.99 193.15 330.72C193.2 331.45 193.83 332.01 194.56 331.96L194.38 329.31H194.39ZM200.33 331.49C201.06 331.42 201.6 330.77 201.53 330.04C201.46 329.31 200.81 328.77 200.08 328.84L200.33 331.48V331.49ZM208.66 327.85C207.93 327.95 207.42 328.62 207.52 329.35C207.62 330.08 208.29 330.58 209.02 330.48L208.66 327.85ZM214.74 329.62C215.46 329.5 215.95 328.82 215.84 328.09C215.72 327.37 215.04 326.88 214.31 326.99L214.74 329.61V329.62ZM222.8 325.43C222.08 325.58 221.62 326.28 221.76 327C221.91 327.72 222.61 328.18 223.33 328.04L222.8 325.44V325.43ZM228.98 326.81C229.7 326.65 230.14 325.93 229.98 325.22C229.82 324.5 229.1 324.06 228.39 324.22L228.98 326.81ZM236.77 322.14C236.06 322.33 235.64 323.06 235.83 323.77C236.02 324.48 236.75 324.9 237.46 324.71L236.77 322.14ZM243.02 323.15C243.72 322.94 244.13 322.2 243.92 321.5C243.71 320.8 242.98 320.39 242.27 320.6L243.02 323.15ZM250.53 318.03C249.83 318.26 249.46 319.01 249.68 319.71C249.91 320.41 250.66 320.79 251.36 320.55L250.53 318.03ZM256.83 318.68C257.52 318.43 257.88 317.67 257.64 316.98C257.39 316.29 256.63 315.93 255.94 316.17L256.83 318.67V318.68ZM264.03 313.14C263.35 313.41 263.01 314.18 263.28 314.86C263.55 315.54 264.32 315.88 265 315.61L264.02 313.14H264.03ZM270.36 313.43C271.04 313.15 271.35 312.37 271.07 311.69C270.78 311.01 270.01 310.7 269.33 310.98L270.36 313.43ZM277.23 307.49C276.56 307.8 276.27 308.59 276.58 309.25C276.89 309.92 277.68 310.21 278.34 309.9L277.23 307.49ZM283.56 307.42C284.22 307.1 284.49 306.3 284.17 305.64C283.85 304.98 283.05 304.71 282.39 305.03L283.56 307.42ZM290.08 301.09C289.43 301.44 289.19 302.24 289.54 302.89C289.89 303.54 290.69 303.78 291.34 303.43L290.09 301.09H290.08ZM296.4 300.65C297.04 300.29 297.26 299.48 296.9 298.84C296.54 298.2 295.73 297.98 295.09 298.34L296.4 300.65ZM302.53 293.94C301.91 294.33 301.71 295.14 302.1 295.77C302.49 296.39 303.3 296.59 303.93 296.2L302.54 293.94H302.53ZM86.91 243.32C86.39 244.11 85.9 244.92 85.46 245.76L87.81 247C88.21 246.24 88.65 245.5 89.12 244.79L86.91 243.32ZM82.56 253.77C82.16 255.57 81.9 257.43 81.77 259.32L84.42 259.5C84.54 257.73 84.78 256.01 85.15 254.34L82.56 253.77ZM82.01 267.74C82.23 269.55 82.54 271.38 82.96 273.21L85.55 272.62C85.16 270.87 84.85 269.14 84.65 267.42L82.01 267.73V267.74ZM85.37 281.22C86.01 282.93 86.74 284.62 87.54 286.3L89.94 285.16C89.17 283.55 88.48 281.92 87.86 280.28L85.37 281.22ZM91.58 293.6C92.56 295.14 93.61 296.66 94.72 298.14L96.84 296.54C95.77 295.12 94.76 293.66 93.82 292.17L91.58 293.59V293.6ZM100.12 304.5C101.39 305.83 102.72 307.11 104.1 308.33L105.86 306.34C104.53 305.16 103.26 303.94 102.03 302.66L100.11 304.5H100.12ZM110.7 313.45C111.46 313.97 112.24 314.47 113.03 314.95L114.42 312.68C113.67 312.22 112.92 311.74 112.19 311.25L110.7 313.45ZM113.03 314.95C113.86 315.46 114.69 315.95 115.53 316.43L116.85 314.12C116.03 313.65 115.22 313.17 114.41 312.68L113.02 314.95H113.03ZM123.35 320.48C125.1 321.3 126.88 322.07 128.68 322.8L129.68 320.34C127.92 319.63 126.19 318.87 124.47 318.07L123.35 320.48ZM136.94 325.79C138.78 326.38 140.63 326.93 142.51 327.43L143.2 324.86C141.36 324.37 139.55 323.83 137.75 323.25L136.94 325.78V325.79ZM151.06 329.43C152.95 329.81 154.85 330.15 156.77 330.45L157.18 327.83C155.3 327.53 153.43 327.2 151.58 326.83L151.06 329.43ZM165.46 331.56C167.38 331.75 169.3 331.9 171.24 332.02L171.41 329.37C169.51 329.25 167.61 329.1 165.73 328.91L165.47 331.55L165.46 331.56ZM179.99 332.35C181.91 332.37 183.84 332.36 185.78 332.32L185.73 329.66C183.82 329.7 181.92 329.71 180.02 329.69L179.99 332.35ZM194.53 331.94C196.45 331.81 198.37 331.66 200.29 331.47L200.04 328.83C198.14 329.01 196.24 329.16 194.35 329.29L194.53 331.94ZM208.98 330.46C210.88 330.2 212.79 329.91 214.7 329.6L214.27 326.98C212.39 327.29 210.5 327.57 208.62 327.83L208.98 330.46ZM223.29 328.02C225.18 327.64 227.06 327.23 228.94 326.8L228.35 324.21C226.49 324.64 224.63 325.04 222.76 325.42L223.29 328.02ZM237.42 324.69C239.28 324.19 241.13 323.67 242.99 323.13L242.24 320.58C240.41 321.12 238.58 321.63 236.73 322.12L237.42 324.69ZM251.32 320.53C253.15 319.92 254.97 319.3 256.78 318.65L255.89 316.15C254.09 316.79 252.29 317.41 250.48 318.01L251.31 320.53H251.32ZM264.96 315.58C266.75 314.87 268.54 314.14 270.31 313.4L269.28 310.95C267.53 311.69 265.76 312.41 263.98 313.11L264.96 315.58ZM278.3 309.87C280.05 309.06 281.79 308.23 283.52 307.39L282.35 305C280.64 305.84 278.92 306.66 277.19 307.46L278.3 309.87ZM291.3 303.4C293 302.49 294.69 301.56 296.36 300.61L295.05 298.3C293.4 299.23 291.73 300.15 290.04 301.06L291.29 303.4H291.3ZM303.89 296.16C304.71 295.65 305.52 295.14 306.33 294.63L304.91 292.39C304.11 292.9 303.31 293.4 302.5 293.9L303.89 296.16Z" fill="#FFB902"/>\r
<path fill-rule="evenodd" clip-rule="evenodd" d="M178.56 259.2H131.3V239.3H178.56V259.2Z" fill="#8F9297"/>\r
<path fill-rule="evenodd" clip-rule="evenodd" d="M112.23 259.2H185.09V252.73H117.75C114.7 252.73 112.23 255.63 112.23 259.2Z" fill="#ABAEB3"/>\r
<path d="M153.59 160.95H136.13V178.41H153.59V160.95Z" fill="#F25022"/>\r
<path d="M172.89 160.95H155.43V178.41H172.89V160.95Z" fill="#80BA01"/>\r
<path d="M172.89 180.25H155.43V197.71H172.89V180.25Z" fill="#FFB902"/>\r
<path d="M153.59 180.25H136.13V197.71H153.59V180.25Z" fill="#02A4EF"/>\r
<path d="M277.5 162.33C278.33 162.33 279 161.66 279 160.83C279 160 278.33 159.33 277.5 159.33C276.67 159.33 276 160 276 160.83C276 161.66 276.67 162.33 277.5 162.33Z" fill="#F2F2F2"/>\r
<path d="M70.24 232.67C67.79 232.67 65.8 230.66 65.8 228.17V126.91C65.8 124.42 67.79 122.41 70.24 122.41H238.79C241.24 122.41 243.23 124.42 243.23 126.91V156H249.86V120.07C249.86 118.16 248.32 116.61 246.42 116.61H63.44C61.54 116.61 60 118.16 60 120.07V235.84C60 237.75 61.54 2